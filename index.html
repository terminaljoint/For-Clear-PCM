<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>For Clear PCM – Structured JEE Learning</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{overscroll-behavior-y:auto;overscroll-behavior-x:none;touch-action:pan-y}
body{font-family:"Comic Sans MS","Comic Neue",system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;background:#0d1117;color:#e6edf3;min-height:100vh;display:flex;flex-direction:column}
header{padding:14px 16px;border-bottom:1px solid #30363d}
.brand{font-size:clamp(1.4rem,4.5vw,1.9rem);font-weight:700}
.subtitle{color:#9aa4af;margin-top:2px;font-size:clamp(.75rem,3vw,.9rem)}
.subject-bar{display:flex;gap:8px;padding:10px 14px;border-bottom:1px solid #30363d;overflow-x:auto;-webkit-overflow-scrolling:touch}
.subject-btn{padding:8px 14px;border:1px solid #30363d;border-radius:14px;cursor:pointer;font-weight:700;white-space:nowrap;font-size:.9rem}
.subject-btn.active{border-color:#2f81f7;color:#2f81f7}
main{max-width:960px;margin:0 auto;padding:16px 14px;flex:1}
.item{padding:14px;border:1px solid #30363d;border-radius:16px;margin-bottom:10px;cursor:pointer;font-size:.95rem}
.breadcrumb{display:flex;align-items:center;gap:4px;font-size:.8rem;white-space:nowrap;overflow-x:auto;font-family:"Comic Sans MS","Comic Neue",cursive;color:#9aa4af}
.breadcrumb span{cursor:pointer;pointer-events:auto}
.breadcrumb span:last-child{color:#e6edf3;font-weight:700}
.top-bar{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
.backBtn{cursor:pointer;color:#2f81f7;font-weight:700;font-size:.9rem;width:max-content}
footer{border-top:1px solid #30363d;padding:10px 12px;font-size:.7rem;color:#9aa4af;text-align:center}
textarea{width:100%;min-height:260px;background:#0d1117;color:#e6edf3;border:1px solid #30363d;border-radius:18px;padding:18px;font-size:1.05rem;line-height:1.65;font-family:"Comic Sans MS","Comic Neue",cursive}
#saveBtn{margin-top:8px;padding:8px 14px;border:1px solid #2f81f7;color:#2f81f7;border-radius:12px;cursor:pointer;width:max-content}
</style>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig={apiKey:"AIzaSyAPzgwYDQQqR4y8aRcu8BmXfhYoLPXDuVM",authDomain:"forclearpcm.firebaseapp.com",projectId:"forclearpcm",storageBucket:"forclearpcm.firebasestorage.app",messagingSenderId:"313585574692",appId:"1:313585574692:web:d4e1262ce22c7cd0bb89b1"};
const app=initializeApp(firebaseConfig);
const db=getFirestore(app);

const OWNER_PASSWORD="FailMarks";
let OWNER_UNLOCKED=false;
let stack=[];
let view,subjectBtns;

function checkLock(){OWNER_UNLOCKED=localStorage.getItem("OWNER_UNLOCK")==="YES"}
function unlockOwner(){const p=prompt("Owner password");if(p===OWNER_PASSWORD){OWNER_UNLOCKED=true;localStorage.setItem("OWNER_UNLOCK","YES");render(false)}}

// REAL SYLLABUS DATA (owner editing relies on leaf detection)
const syllabus = window.syllabus || {};

function getCurrentData(){let ref=syllabus;for(const k of stack){if(ref&&typeof ref==="object"&&k in ref){ref=ref[k]}else return null}return ref}
// A leaf means: no children OR explicitly marked editable
function isLeaf(obj){
  return obj && typeof obj === "object" && (
    Object.keys(obj).length === 0 || obj.__leaf === true
  );
}

function syncHistory(){history.pushState({stack:[...stack]},"",`#${stack.join("/")||"root"}`)}
function restoreFromHistory(state){if(state&&Array.isArray(state.stack)){stack=[...state.stack];render(false)}}

async function render(pushHistory=true){
checkLock();
if(pushHistory)syncHistory();
subjectBtns.forEach(b=>b.classList.toggle("active",b.dataset.sub===stack[0]));
view.innerHTML="";
if(stack.length===0){view.innerHTML="<h2>Select a subject</h2>";return}
const data=getCurrentData();
if(!data){view.innerHTML="<div>Invalid path</div>";return}

const top=document.createElement("div");
top.className="top-bar";
if(stack.length>1){const back=document.createElement("div");back.className="backBtn";back.textContent="← Back";back.onclick=()=>{stack.pop();render()};top.appendChild(back)}

const bc=document.createElement("div");bc.className="breadcrumb";
stack.forEach((name,idx)=>{
const span=document.createElement("span");
span.textContent=name;
span.style.color=idx===stack.length-1?"#e6edf3":"#2f81f7";
span.onclick=()=>{stack=stack.slice(0,idx+1);render()};
bc.appendChild(span);
if(idx<stack.length-1){const sep=document.createElement("span");sep.textContent=" → ";sep.style.color="#9aa4af";bc.appendChild(sep)}
});

top.appendChild(bc);
view.appendChild(top);

if(isLeaf(data)){
// owner editing zone
// Stable Firestore path per node
const path="content/"+stack.join("__");("__");
let saved="";
try{const snap=await getDoc(doc(db,path));if(snap.exists())saved=snap.data().text||""}catch(e){console.error(e)}
if(OWNER_UNLOCKED){
// OWNER CAN ALWAYS EDIT LEAF CONTENT
view.insertAdjacentHTML("beforeend",`<textarea id="editor">${saved}</textarea><div id="saveBtn">Save</div>`);
document.getElementById("saveBtn").onclick=async()=>{
await setDoc(doc(db,path),{text:document.getElementById("editor").value,updatedAt:Date.now()});
alert("Saved")};
}else if(saved){
view.insertAdjacentHTML("beforeend",`<pre style="font-family:'Comic Sans MS','Comic Neue',cursive">${saved}</pre>`)
}
return;
}

Object.keys(data).forEach(k=>{const d=document.createElement("div");d.className="item";d.textContent=k;d.onclick=()=>{stack.push(k);render()};view.appendChild(d)})
}

window.addEventListener("popstate",e=>restoreFromHistory(e.state));
window.addEventListener("DOMContentLoaded",()=>{
// expose syllabus globally so editor logic works
window.syllabus = syllabus;,()=>{
view=document.getElementById("view");
subjectBtns=document.querySelectorAll(".subject-btn");
subjectBtns.forEach(b=>b.onclick=()=>{stack=[b.dataset.sub];render()});
render(false)
});
</script>
</head>
<body>
<header><h1 class="brand">For clear PCM</h1><p class="subtitle">Structured JEE learning</p></header>
<div class="subject-bar">
<div class="subject-btn" data-sub="Maths">Maths</div>
<div class="subject-btn" data-sub="Physics">Physics</div>
<div class="subject-btn" data-sub="Chemistry">Chemistry</div>
</div>
<main><div id="view"></div></main>
<footer>©2026 Terminal Joint · For Clear PCM</footer>
</body>
</html>
