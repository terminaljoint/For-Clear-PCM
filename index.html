<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>For Clear PCM – Structured JEE Learning</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#0d1117;--panel:#0f141b;--border:#30363d;--text:#e6edf3;--muted:#9aa4af;--accent:#2f81f7;--danger:#f85149;
  --radius:14px;--pad:12px;--pad-lg:16px;--shadow:0 10px 30px rgba(0,0,0,.25);
}
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%}
body{font-family:"Comic Sans MS","Comic Neue",cursive;background:var(--bg);color:var(--text);display:flex;flex-direction:column}

/* Header */
header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,rgba(13,17,23,.98),rgba(13,17,23,.9));border-bottom:1px solid var(--border)}
.header-inner{max-width:1100px;margin:0 auto;padding:12px 14px;display:flex;align-items:center;justify-content:space-between;gap:12px}
.brand{display:flex;flex-direction:column}
.brand .title{font-size:1.5rem;font-weight:700}
.brand .subtitle{font-size:.8rem;color:var(--muted)}
.auth{display:flex;align-items:center;gap:8px}
.badge{display:none;font-size:.7rem;font-weight:700;color:var(--accent);border:1px solid rgba(47,129,247,.35);padding:3px 8px;border-radius:999px}
.btn{cursor:pointer;border:1px solid var(--border);background:transparent;color:var(--muted);padding:6px 12px;border-radius:10px;transition:.15s}
.btn:hover{border-color:var(--accent);color:var(--text)}

/* Subject bar */
.subject-bar{border-bottom:1px solid var(--border);background:var(--panel)}
.subject-inner{max-width:1100px;margin:0 auto;padding:8px 14px;display:flex;gap:8px;overflow-x:auto}
.subject-inner::-webkit-scrollbar{display:none}
.subject-btn{white-space:nowrap;padding:8px 14px;border:1px solid var(--border);border-radius:999px;font-weight:700;color:var(--muted);transition:.15s}
.subject-btn:hover{border-color:var(--accent);color:var(--text)}
.subject-btn.active{border-color:var(--accent);color:var(--accent)}

/* Main */
main{flex:1}
.main-inner{max-width:1100px;margin:0 auto;padding:14px}

/* Breadcrumb */
.breadcrumb{display:flex;align-items:center;gap:6px;font-size:.8rem;color:var(--muted);white-space:nowrap;overflow-x:auto;margin-bottom:10px}
.breadcrumb::-webkit-scrollbar{display:none}
.breadcrumb .crumb{cursor:pointer;padding:4px 6px;border-radius:6px}
.breadcrumb .crumb:hover{background:rgba(47,129,247,.08);color:var(--text)}
.breadcrumb .sep{opacity:.5}

/* Filters (global) */
.filters{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:10px}
.filters .label{font-size:.75rem;color:var(--muted)}
.tag{font-size:.65rem;border:1px solid var(--border);border-radius:999px;padding:2px 8px;color:var(--muted);cursor:pointer}
.tag.active{border-color:var(--accent);color:var(--accent)}

/* Dashboard */
.dashboard{border:1px solid var(--border);border-radius:12px;background:var(--panel);padding:10px;margin-bottom:10px;box-shadow:var(--shadow)}
.dashboard .title{font-size:.85rem;font-weight:700;margin-bottom:6px}
.dashboard .list{display:flex;flex-wrap:wrap;gap:6px}
.dashboard .pill{font-size:.65rem;border:1px solid var(--border);border-radius:999px;padding:3px 8px;color:var(--muted);cursor:pointer}
.dashboard .pill:hover{border-color:var(--accent);color:var(--text)}

/* Summary */
.summary{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:10px}
.summary .box{border:1px solid var(--border);border-radius:12px;padding:8px 10px;background:var(--panel)}
.summary .box .k{font-size:.7rem;color:var(--muted)}
.summary .box .v{font-size:.85rem;font-weight:700}

/* Grid */
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px}
.card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.0));border:1px solid var(--border);border-radius:var(--radius);padding:var(--pad-lg);display:flex;flex-direction:column;gap:8px;transition:.15s;box-shadow:var(--shadow)}
.card:hover{border-color:var(--accent);transform:translateY(-1px)}
.card .row{display:flex;align-items:center;justify-content:space-between;gap:10px}
.card .name{font-weight:700}
.controls{display:flex;gap:6px}
.controls .mini{font-size:.7rem;padding:4px 7px;border-radius:8px}

/* Progress bar */
.progress{height:6px;background:#0b0f14;border:1px solid var(--border);border-radius:999px;overflow:hidden}
.progress > div{height:100%;background:var(--accent);width:0%}
.progress-label{font-size:.65rem;color:var(--muted)}

/* Editor */
.editor{border:1px solid var(--border);border-radius:var(--radius);background:var(--panel);padding:var(--pad-lg);box-shadow:var(--shadow)}
.editor textarea{width:100%;min-height:260px;background:transparent;color:var(--text);border:1px solid var(--border);border-radius:12px;padding:12px;font-size:1rem;line-height:1.6;resize:vertical}
.editor .hint{font-size:.75rem;color:var(--muted);margin-top:6px}

/* Notices */
.notice{border:1px dashed var(--danger);color:var(--danger);border-radius:10px;padding:10px;font-size:.8rem;margin-bottom:10px}

/* Footer */
footer{border-top:1px solid var(--border);background:var(--panel)}
.footer-inner{max-width:1100px;margin:0 auto;padding:10px 14px;font-size:.7rem;color:var(--muted);text-align:center}

/* Empty */
.empty{border:1px dashed var(--border);border-radius:12px;padding:14px;color:var(--muted);text-align:center}
</style>
</head>
<body>
<header>
  <div class="header-inner">
    <div class="brand">
      <div class="title">For Clear PCM</div>
      <div class="subtitle">Structured JEE learning</div>
    </div>
    <div class="auth">
      <span id="ownerBadge" class="badge">OWNER</span>
      <button id="loginBtn" class="btn">Login</button>
      <button id="logoutBtn" class="btn" style="display:none">Logout</button>
    </div>
  </div>
</header>

<div class="subject-bar">
  <div class="subject-inner">
    <button class="subject-btn" data-sub="Maths">Maths</button>
    <button class="subject-btn" data-sub="Physics">Physics</button>
    <button class="subject-btn" data-sub="Chemistry">Chemistry</button>
  </div>
</div>

<main>
  <div class="main-inner">
    <div id="breadcrumb" class="breadcrumb"></div>
    <div id="filters" class="filters"></div>
    <div id="dashboard" class="dashboard" style="display:none"></div>
    <div id="summary" class="summary"></div>
    <div id="view"></div>
  </div>
</main>

<footer>
  <div class="footer-inner">©2026 Terminal Joint · For Clear PCM</div>
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyAPzgwYDQQqR4y8aRcu8BmXfhYoLPXDuVM",
  authDomain: "forclearpcm.firebaseapp.com",
  projectId: "forclearpcm",
  storageBucket: "forclearpcm.appspot.com",
  messagingSenderId: "313585574692",
  appId: "1:313585574692:web:d4e1262ce22c7cd0bb89b1"
};

const OWNER_UID = "XS23F6EEK4VjO3ahyx5LVakP1Bd2";

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let user = null;
let tree = {};
let stack = [];
let permissionError = false;
let activeTag = null; // tag filter
let showOnlyNotUnderstood = false; // revision filter

const view = document.getElementById("view");
const breadcrumb = document.getElementById("breadcrumb");
const filters = document.getElementById("filters");
const summary = document.getElementById("summary");
const dashboard = document.getElementById("dashboard");
const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const ownerBadge = document.getElementById("ownerBadge");

function isOwner(){ return user && user.uid === OWNER_UID; }
// Always return a valid document id (never empty)
function pathId(path = stack){
  const id = (path && path.length ? path.join("__") : "root");
  return id;
}

// History sync
window.addEventListener("popstate", e => {
  if(e.state && Array.isArray(e.state.stack)){
    stack = e.state.stack;
  } else if(stack.length > 0){
    stack.pop();
  }
  render(false);
});

async function loadTree(){
  try{
    const ref = doc(db,"syllabus","root");
    const snap = await getDoc(ref);
    if(snap.exists()){
      tree = snap.data().tree || {};
    } else {
      tree = { Maths:{}, Physics:{}, Chemistry:{} };
      if(isOwner()) await setDoc(ref,{tree});
    }
  }catch(e){
    console.error(e);
    permissionError = true;
    tree = { Maths:{}, Physics:{}, Chemistry:{} };
  }
}

function getNode(){
  let ref = tree;
  for(const k of stack){ if(ref && k in ref) ref = ref[k]; }
  return ref || {};
}

function renderBreadcrumb(){
  breadcrumb.innerHTML = "";
  const home = document.createElement('span'); home.textContent = 'Home'; home.className = 'crumb';
  home.onclick = () => { stack = []; render(); };
  breadcrumb.appendChild(home);
  for(let i=0;i<stack.length;i++){
    const sep = document.createElement('span'); sep.textContent = '›'; sep.className = 'sep'; breadcrumb.appendChild(sep);
    const sp = document.createElement('span'); sp.textContent = stack[i]; sp.className = 'crumb'; sp.dataset.i = i;
    sp.onclick = () => { stack = stack.slice(0, Number(sp.dataset.i) + 1); render(); };
    breadcrumb.appendChild(sp);
  }
}

async function getMeta(path = stack){
  try{
    // Ensure even segments: collection 'meta' + document id
    const snap = await getDoc(doc(db, "meta", pathId(path)));
    if(snap.exists()) return snap.data();
  }catch(e){ console.error(e); }
  return { progress:0, tags:[] };
}

async function saveMeta(meta, path = stack){
  try{
    // Ensure even segments: collection 'meta' + document id
    await setDoc(doc(db, "meta", pathId(path)), meta, { merge:true });
  }catch(e){ console.error(e); }
}

// Recursively aggregate progress and tags, and count not-understood leaves
async function aggregate(path, node){
  const meta = await getMeta(path);
  let total = 0, count = 0, tagged = 0, notUnderstood = 0;
  if(Object.keys(node).length === 0){
    const isTagged = activeTag && (meta.tags||[]).includes(activeTag);
    const isNot = (meta.progress||0) !== 100;
    return { progress: meta.progress||0, count:1, tagged: isTagged?1:0, notUnderstood: isNot?1:0 };
  }
  for(const k in node){
    const child = await aggregate([...path, k], node[k]);
    total += child.progress; count += child.count; tagged += child.tagged; notUnderstood += child.notUnderstood;
  }
  return { progress: count? Math.round(total/count):0, count, tagged, notUnderstood };
}

function renderFilters(){
  filters.innerHTML = '';
  const label = document.createElement('span'); label.className='label'; label.textContent='Filter:'; filters.appendChild(label);
  ['important','formula','example'].forEach(t=>{
    const s = document.createElement('span'); s.className='tag'; s.textContent=t.toUpperCase();
    if(activeTag===t) s.classList.add('active');
    s.onclick = ()=>{ activeTag = (activeTag===t? null:t); render(false); };
    filters.appendChild(s);
  });
  const rev = document.createElement('span'); rev.className='tag'; rev.textContent='REVISION (NOT UNDERSTOOD)';
  if(showOnlyNotUnderstood) rev.classList.add('active');
  rev.onclick = ()=>{ showOnlyNotUnderstood = !showOnlyNotUnderstood; render(false); };
  filters.appendChild(rev);
}

async function renderDashboard(){
  const node = getNode();
  const items = [];
  async function walk(path, n){
    if(Object.keys(n).length === 0){
      const meta = await getMeta(path);
      if((meta.progress||0) !== 100) items.push(path);
      return;
    }
    for(const k in n) await walk([...path, k], n[k]);
  }
  await walk(stack, node);

  if(items.length === 0){ dashboard.style.display='none'; return; }
  dashboard.style.display='block';
  dashboard.innerHTML='';
  const t = document.createElement('div'); t.className='title'; t.textContent='Not understood (click to open):';
  const list = document.createElement('div'); list.className='list';
  items.slice(0, 50).forEach(p=>{
    const pill = document.createElement('span'); pill.className='pill'; pill.textContent=p.join(' › ');
    pill.onclick=()=>{ stack=[...p]; render(); };
    list.appendChild(pill);
  });
  dashboard.appendChild(t); dashboard.appendChild(list);
}

async function renderSummary(){
  summary.innerHTML='';
  const node = getNode();
  const agg = await aggregate(stack, node);
  const b1 = document.createElement('div'); b1.className='box'; b1.innerHTML = `<div class="k">Progress</div><div class="v">${agg.progress}%</div>`;
  const b2 = document.createElement('div'); b2.className='box'; b2.innerHTML = `<div class="k">Items</div><div class="v">${agg.count}</div>`;
  const b3 = document.createElement('div'); b3.className='box'; b3.innerHTML = `<div class="k">Tagged</div><div class="v">${agg.tagged}</div>`;
  const b4 = document.createElement('div'); b4.className='box'; b4.innerHTML = `<div class="k">Not understood</div><div class="v">${agg.notUnderstood}</div>`;
  summary.appendChild(b1); summary.appendChild(b2); summary.appendChild(b3); summary.appendChild(b4);
}

async function render(pushHistory = true){
  if(pushHistory){ history.pushState({ stack:[...stack] }, ""); }
  view.innerHTML = "";
  renderBreadcrumb();
  renderFilters();
  await renderDashboard();
  await renderSummary();

  if(permissionError){
    const n = document.createElement("div"); n.className = "notice";
    n.textContent = "Firestore permission error. Public read-only fallback mode.";
    view.appendChild(n);
  }

  const node = getNode();

  // Leaf: content + UNDERSTOOD toggle
  if(Object.keys(node).length === 0){
    let text = "";
    try{
      const snap = await getDoc(doc(db, "content", pathId()));
      if(snap.exists()) text = snap.data().text || "";
    }catch(e){ console.error(e); }

    const meta = await getMeta();

    const wrap = document.createElement('div'); wrap.className = 'editor';

    // Progress bar (binary)
    const p = document.createElement('div'); p.className='progress';
    const pf=document.createElement('div'); pf.style.width=(meta.progress||0)+'%'; p.appendChild(pf);
    const pl=document.createElement('div'); pl.className='progress-label'; pl.textContent = meta.progress===100 ? 'Status: UNDERSTOOD' : 'Status: NOT UNDERSTOOD';
    wrap.appendChild(p); wrap.appendChild(pl);

    // Tags
    const tagRow=document.createElement('div'); tagRow.style.margin='6px 0 10px';
    ['important','formula','example'].forEach(t=>{
      const s=document.createElement('span'); s.className='tag'; s.textContent=t.toUpperCase(); if((meta.tags||[]).includes(t)) s.classList.add('active');
      if(isOwner() && !permissionError){
        s.onclick=async()=>{ const cur=new Set(meta.tags||[]); cur.has(t)?cur.delete(t):cur.add(t); meta.tags=Array.from(cur); await saveMeta(meta); render(false); };
      }
      tagRow.appendChild(s);
    });
    wrap.appendChild(tagRow);

    // UNDERSTOOD toggle
    const btn = document.createElement('button'); btn.className='btn';
    btn.textContent = meta.progress===100 ? 'Revert (Not Understood)' : 'Understood';
    btn.onclick = async () => { meta.progress = meta.progress===100 ? 0 : 100; await saveMeta(meta); render(false); };
    wrap.appendChild(btn);

    if(isOwner() && !permissionError){
      const ta = document.createElement("textarea"); ta.value = text;
      ta.onchange = async () => { try{ await setDoc(doc(db, "content", pathId()), { text: ta.value }, { merge:true }); }catch(e){ alert("Save failed"); } };
      wrap.appendChild(ta);

      const hint=document.createElement('div'); hint.className='hint'; hint.textContent='Progress updates only via the UNDERSTOOD button. Click again to revert.'; wrap.appendChild(hint);
    } else {
      if(text.trim().length===0){ const empty=document.createElement('div'); empty.className='empty'; empty.textContent='No content here yet.'; wrap.appendChild(empty);} 
      else { const pre=document.createElement('pre'); pre.textContent=text; pre.style.whiteSpace='pre-wrap'; wrap.appendChild(pre);} 
    }

    view.appendChild(wrap);
    return;
  }

  // Non-leaf: cards with aggregated progress
  const grid = document.createElement('div'); grid.className = 'grid';

  for(const key in node){
    const childPath=[...stack,key];
    const agg=await aggregate(childPath, node[key]);
    if(activeTag && agg.tagged===0) continue;
    if(showOnlyNotUnderstood && agg.notUnderstood===0) continue;

    const card = document.createElement("div"); card.className = "card";

    const row=document.createElement('div'); row.className='row';
    const name = document.createElement('div'); name.className='name'; name.textContent = key;
    const c = document.createElement("div"); c.className = "controls";

    if(isOwner() && !permissionError){
      const add = document.createElement("button"); add.className = 'btn mini'; add.textContent = "+"; add.title = 'Add child';
      add.onclick = e => { e.stopPropagation(); const n = prompt("New child name"); if(n){ node[key][n] = {}; saveTree().then(() => render()); } };
      c.appendChild(add);
    }

    row.appendChild(name); row.appendChild(c); card.appendChild(row);

    const pbar=document.createElement('div'); pbar.className='progress';
    const pfill=document.createElement('div'); pfill.style.width=agg.progress+'%'; pbar.appendChild(pfill);
    const plabel=document.createElement('div'); plabel.className='progress-label'; plabel.textContent=`${agg.progress}% · ${agg.count} items · ${agg.notUnderstood} not understood`;
    card.appendChild(pbar); card.appendChild(plabel);

    card.onclick = () => { stack.push(key); render(); };
    grid.appendChild(card);
  }

  view.appendChild(grid);
}

async function saveTree(){
  if(!isOwner()) return;
  try{ await setDoc(doc(db, "syllabus", "root"), { tree }); }
  catch(e){ console.error(e); permissionError = true; }
}

// Auth
loginBtn.onclick = () => signInWithPopup(auth, new GoogleAuthProvider());
logoutBtn.onclick = () => signOut(auth);

onAuthStateChanged(auth, async u => {
  user = u;
  loginBtn.style.display = u ? "none" : "inline-block";
  logoutBtn.style.display = u ? "inline-block" : "none";
  ownerBadge.style.display = isOwner() ? "inline" : "none";
  permissionError = false;
  await loadTree();
  render(false);
});

// Subject buttons
Array.from(document.querySelectorAll('.subject-btn')).forEach(b => {
  b.onclick = () => {
    Array.from(document.querySelectorAll('.subject-btn')).forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    stack = [b.dataset.sub];
    render();
  };
});
</script>
</body>
</html>
