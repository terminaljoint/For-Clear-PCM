<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>For Clear PCM – Structured JEE Learning</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&display=swap" rel="stylesheet">

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:"Comic Sans MS","Comic Neue",cursive;background:#0d1117;color:#e6edf3;min-height:100vh;display:flex;flex-direction:column}
header{padding:14px 16px;border-bottom:1px solid #30363d;display:flex;justify-content:space-between;align-items:center}
.brand{font-size:1.6rem;font-weight:700}
.subtitle{font-size:.8rem;color:#9aa4af}
button{cursor:pointer}
#loginBtn,#logoutBtn{border:1px solid #30363d;background:none;color:#9aa4af;padding:6px 12px;border-radius:10px}
#ownerBadge{color:#2f81f7;font-weight:700;font-size:.75rem;display:none;margin-right:8px}
.subject-bar{display:flex;gap:8px;padding:10px;border-bottom:1px solid #30363d;overflow-x:auto;-webkit-overflow-scrolling:touch}
.subject-bar::-webkit-scrollbar{display:none}
.subject-btn{padding:8px 14px;border:1px solid #30363d;border-radius:14px;cursor:pointer;font-weight:700}
.subject-btn.active{border-color:#2f81f7;color:#2f81f7}
main{flex:1;max-width:960px;margin:0 auto;padding:16px}
.breadcrumb{font-size:.8rem;color:#9aa4af;margin-bottom:12px;white-space:nowrap;overflow-x:auto;-webkit-overflow-scrolling:touch}
.breadcrumb::-webkit-scrollbar{display:none}
.breadcrumb span{cursor:pointer}
.item{padding:12px;border:1px solid #30363d;border-radius:14px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center}
.controls button{margin-left:6px;border:1px solid #30363d;background:none;color:#9aa4af;border-radius:8px;padding:2px 6px;font-size:.75rem}
textarea{width:100%;min-height:260px;background:#0d1117;color:#e6edf3;border:1px solid #30363d;border-radius:16px;padding:14px;font-size:1rem;line-height:1.6}
.notice{padding:10px;border:1px dashed #f85149;color:#f85149;border-radius:10px;font-size:.8rem;margin-bottom:10px}
footer{border-top:1px solid #30363d;padding:10px;font-size:.7rem;color:#9aa4af;text-align:center}
</style>
</head>
<body>
<header>
  <div>
    <div class="brand">For Clear PCM</div>
    <div class="subtitle">Structured JEE learning</div>
  </div>
  <div>
    <span id="ownerBadge">OWNER</span>
    <button id="loginBtn">Login</button>
    <button id="logoutBtn" style="display:none">Logout</button>
  </div>
</header>

<div class="subject-bar">
  <div class="subject-btn" data-sub="Maths">Maths</div>
  <div class="subject-btn" data-sub="Physics">Physics</div>
  <div class="subject-btn" data-sub="Chemistry">Chemistry</div>
</div>

<main>
  <div class="breadcrumb" id="breadcrumb"></div>
  <div id="view"></div>
</main>

<footer>©2026 Terminal Joint · For Clear PCM</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyAPzgwYDQQqR4y8aRcu8BmXfhYoLPXDuVM",
  authDomain: "forclearpcm.firebaseapp.com",
  projectId: "forclearpcm",
  storageBucket: "forclearpcm.appspot.com",
  messagingSenderId: "313585574692",
  appId: "1:313585574692:web:d4e1262ce22c7cd0bb89b1"
};

const OWNER_UID = "XS23F6EEK4VjO3ahyx5LVakP1Bd2";

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let user = null;
let tree = {};
let stack = [];
let permissionError = false;

const view = document.getElementById("view");
const breadcrumb = document.getElementById("breadcrumb");

function isOwner(){ return user && user.uid === OWNER_UID; }
function pathId(){ return stack.join("__"); }

// HISTORY SYNC (mobile-safe)
window.addEventListener("popstate", e => {
  if(e.state && Array.isArray(e.state.stack)){
    stack = e.state.stack;
  } else if(stack.length > 0){
    stack.pop();
  }
  render(false);
});

async function loadTree(){
  try{
    const ref = doc(db,"syllabus","root");
    const snap = await getDoc(ref);
    if(snap.exists()){
      tree = snap.data().tree || {};
    }else{
      tree = { Maths:{}, Physics:{}, Chemistry:{} };
      if(isOwner()){
        await setDoc(ref,{tree});
      }
    }
  }catch(e){
    console.error(e);
    permissionError = true;
    tree = { Maths:{}, Physics:{}, Chemistry:{} };
  }
}

function getNode(){
  let ref = tree;
  for(const k of stack){ if(ref && k in ref) ref = ref[k]; }
  return ref || {};
}

function renderBreadcrumb(){
  breadcrumb.innerHTML = stack.map((s,i)=>`<span data-i="${i}">${s}</span>`).join(" / ");
  breadcrumb.querySelectorAll("span").forEach(sp => {
    sp.onclick = () => {
      stack = stack.slice(0, Number(sp.dataset.i) + 1);
      render();
    };
  });
}

async function render(pushHistory = true){
  if(pushHistory){
    history.pushState({ stack:[...stack] }, "");
  }
  view.innerHTML = "";
  renderBreadcrumb();

  if(permissionError){
    const n = document.createElement("div");
    n.className = "notice";
    n.textContent = "Firestore permission error. Public read-only fallback mode.";
    view.appendChild(n);
  }

  const node = getNode();

  if(Object.keys(node).length === 0){
    let text = "";
    try{
      const snap = await getDoc(doc(db,"content",pathId()));
      if(snap.exists()) text = snap.data().text || "";
    }catch(e){ console.error(e); }

    if(isOwner() && !permissionError){
      const ta = document.createElement("textarea");
      ta.value = text;
      ta.onchange = async () => {
        try{
          await setDoc(doc(db,"content",pathId()), { text: ta.value }, { merge:true });
        }catch(e){ alert("Save failed: permission denied"); }
      };
      view.appendChild(ta);
    } else {
      view.innerHTML += `<pre>${text}</pre>`;
    }
    return;
  }

  for(const key in node){
    const d = document.createElement("div");
    d.className = "item";
    d.innerHTML = `<span>${key}</span>`;

    const c = document.createElement("div");
    c.className = "controls";

    if(isOwner() && !permissionError){
      const add = document.createElement("button");
      add.textContent = "+";
      add.onclick = e => {
        e.stopPropagation();
        const n = prompt("New child name");
        if(n){
          node[key][n] = {};
          saveTree().then(() => render());
        }
      };
      c.appendChild(add);
    }

    d.appendChild(c);
    d.onclick = () => {
      stack.push(key);
      render();
    };
    view.appendChild(d);
  }
}

async function saveTree(){
  if(!isOwner()) return;
  try{
    await setDoc(doc(db,"syllabus","root"), { tree });
  }catch(e){
    console.error(e);
    permissionError = true;
  }
}

// AUTH
loginBtn.onclick = () => signInWithPopup(auth, new GoogleAuthProvider());
logoutBtn.onclick = () => signOut(auth);

onAuthStateChanged(auth, async u => {
  user = u;
  loginBtn.style.display = u ? "none" : "inline-block";
  logoutBtn.style.display = u ? "inline-block" : "none";
  ownerBadge.style.display = isOwner() ? "inline" : "none";
  permissionError = false;
  await loadTree();
  render(false);
});

// SUBJECT BUTTONS
Array.from(document.querySelectorAll(".subject-btn")).forEach(b => {
  b.onclick = () => {
    stack = [b.dataset.sub];
    render();
  };
});
</script>
</body>
</html>
